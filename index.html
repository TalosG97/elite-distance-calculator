<script>
  // SYSTEM AUTOCOMPLETE
  async function fetchSystemSuggestions(query) {
    const response = await fetch(`https://www.edsm.net/api-v1/systems?systemName=${encodeURIComponent(query)}&showId=1&limit=5`);
    const data = await response.json();
    return Array.isArray(data) ? data.map(s => s.name) : [];
  }

  function setupSystemAutocomplete(inputId, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestionsBox = document.getElementById(suggestionsId);

    input.addEventListener("input", async () => {
      const query = input.value.trim();
      suggestionsBox.innerHTML = "";
      if (query.length < 3) return;

      try {
        const suggestions = await fetchSystemSuggestions(query);
        suggestions.forEach(name => {
          const div = document.createElement("div");
          div.classList.add("suggestion-item");
          div.textContent = name;
          div.onclick = () => {
            input.value = name;
            suggestionsBox.innerHTML = "";
          };
          suggestionsBox.appendChild(div);
        });
      } catch (err) {
        console.error("Autocomplete error:", err);
      }
    });

    input.addEventListener("blur", () => {
      setTimeout(() => suggestionsBox.innerHTML = "", 200);
    });
  }

  setupSystemAutocomplete("system1", "suggestions1");
  setupSystemAutocomplete("system2", "suggestions2");

  // COORD FETCHING (WITH STATION FALLBACK)
  async function getSystemCoords(name) {
    const sysRes = await fetch(`https://www.edsm.net/api-v1/system?systemName=${encodeURIComponent(name)}&showCoordinates=1`);
    const sysData = await sysRes.json();
    if (sysData?.coords) return sysData.coords;

    const stationRes = await fetch(`https://www.edsm.net/api-v1/station?stationName=${encodeURIComponent(name)}&showSystem=1`);
    const stationData = await stationRes.json();
    if (stationData?.system?.name) {
      const fallbackRes = await fetch(`https://www.edsm.net/api-v1/system?systemName=${encodeURIComponent(stationData.system.name)}&showCoordinates=1`);
      const fallbackData = await fallbackRes.json();
      if (fallbackData?.coords) return fallbackData.coords;
    }

    throw new Error(`"${name}" not found as system or station.`);
  }

  // DISTANCE CALCULATION
  function showLoader(show) {
    document.getElementById("loader").style.display = show ? "block" : "none";
  }

  async function calculateDistance() {
    const name1 = document.getElementById("system1").value.trim();
    const name2 = document.getElementById("system2").value.trim();
    const jumpRange = parseFloat(document.getElementById("jumpRange").value);
    const result = document.getElementById("result");

    result.textContent = "";
    result.style.color = "#c5c6c7";

    if (!name1 || !name2) {
      result.textContent = "Please fill in both origin and destination.";
      result.style.color = "red";
      return;
    }

    showLoader(true);

    try {
      const coords1 = await getSystemCoords(name1);
      const coords2 = await getSystemCoords(name2);

      const dx = coords1.x - coords2.x;
      const dy = coords1.y - coords2.y;
      const dz = coords1.z - coords2.z;
      const distance = Math.sqrt(dx * dx + dy * dy + dz * dz).toFixed(2);

      let jumpsText = "";
      if (!isNaN(jumpRange) && jumpRange > 0) {
        const jumps = Math.ceil(distance / jumpRange);
        jumpsText = ` | Estimated Jumps: ${jumps}`;
      }

      result.textContent = `Distance between "${name1}" and "${name2}": ${distance} LY${jumpsText}`;
    } catch (err) {
      result.textContent = err.message;
      result.style.color = "red";
    }

    showLoader(false);
  }

  // STATION SEARCH
  async function searchStation() {
    const stationInput = document.getElementById("stationInput").value.trim();
    const stationResult = document.getElementById("stationResult");

    stationResult.textContent = "";
    if (!stationInput || stationInput.length < 3) {
      stationResult.textContent = "Please enter a valid station name.";
      stationResult.style.color = "red";
      return;
    }

    try {
      const res = await fetch(`https://www.edsm.net/api-v1/station?stationName=${encodeURIComponent(stationInput)}&showSystem=1`);
      const data = await res.json();

      if (data?.name && data?.system?.name) {
        stationResult.innerHTML = `📍 Station "<strong>${data.name}</strong>" is located in system "<strong>${data.system.name}</strong>"`;
        stationResult.style.color = "#66fcf1";
      } else {
        throw new Error("Station not found.");
      }
    } catch (err) {
      stationResult.textContent = "Station not found or API error.";
      stationResult.style.color = "red";
    }
  }

  // STARFIELD
  const canvas = document.getElementById("stars");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  const stars = Array.from({ length: 150 }, () => ({
    x: Math.random() * window.innerWidth,
    y: Math.random() * window.innerHeight,
    radius: Math.random() * 1.2,
    alpha: Math.random(),
    delta: (Math.random() * 0.02) + 0.005,
  }));

  function drawStars() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    stars.forEach(star => {
      star.alpha += star.delta;
      if (star.alpha <= 0 || star.alpha >= 1) star.delta *= -1;
      ctx.beginPath();
      ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
      ctx.fill();
    });
    requestAnimationFrame(drawStars);
  }

  drawStars();
</script>
